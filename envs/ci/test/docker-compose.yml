name: acih-ci-test

services:
  app-build: &app-build
    build:
      context: ../../..  # path from the current file to the project root dir
      dockerfile: envs/ci/test/Dockerfile  # path from the project root dir to the Dockerfile
      cache_from:
        - type=local,src=${BUILDX_CACHE_SRC}
      cache_to:
        - type=local,dest=${BUILDX_CACHE_DEST}

  minio:
    image: minio/minio:RELEASE.2023-12-06T09-09-22Z
    env_file:
      - .env
    command: ["server", "/data"]

  postgres:
    image: postgres:16.1-alpine
    env_file:
      - .env

  pytest:
    <<: *app-build
    volumes:
      - ~/.pytest_cache:/app/.pytest_cache
    depends_on:
      - postgres
      - minio
    environment:
      - ACIH_ENV=ci/test
    entrypoint: |
      bash -c "
        alembic upgrade head
        pytest --cov=src
      "
